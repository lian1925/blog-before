<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="/css/base.css">
  <link rel="icon" type="image/png" href="/img/robot.png">
  <link rel="stylesheet" href="/css/post.css?v=1.1">
  <link rel="stylesheet" href="//at.alicdn.com/t/font_407924_kx6yx3r9q4m6xbt9.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.css" />

  <title>
    扩展package | PXT |
      小梁哥的个人网站
  </title>
<link rel="stylesheet" href="/css/prism-ghcolors.css" type="text/css"></head>

<body>
  <div class="container">
    <div class="header">

      <a class="home-title" style="cursor:default;" onclick="javascript:void(0);return false;"><span>小梁哥的个人网站
        <i class="iconfont icon-shuangjiantou-copy"></i>
      </span></a>

      <a href="/home/">首页</a>
      <span><i class="iconfont icon-shuangjiantou-copy"></i></span>
      <a href="/tags/PXT/">
        PXT
      </a>
      <div class="search">
        <input type="text" placeholder="搜索">
        <i class="iconfont icon-sousuo"></i>
      </div>
    </div>
    <div class="post">
      <h1>扩展package | PXT</h1>
      <div class="post-meta">
        <p>作者： Lian</p>
        <p>日期：
          2017年10月11日 21:10
        </p>
      </div>
      <div class="share-button"></div>
    </div>
    <div class="page">
      <h1 id="Extensions"><a href="#Extensions" class="headerlink" title="Extensions"></a>Extensions</h1><p>A package may have an associated editor extension hosted in the Github Pages section of the repo.</p>
<ul>
<li><a href="https://github.com/Microsoft/pxt-neoanim" target="_blank" rel="external">pxt-neoanim</a> is an example of specialized NeoPixel animation editor.</li>
</ul>
<h2 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h2><p>The extension is configured in the <a href="/packages/pxtJson">pxt.json</a> file by adding an <code>extension</code> field:</p>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">{
    ...
    extension: {}
}
</code></pre>
<p>The editor will automatically add an “Editor” button for the extension in the package category.</p>
<h2 id="Protocol"><a href="#Protocol" class="headerlink" title="Protocol"></a>Protocol</h2><p>The editor and the extension IFrame communicate via a protocol of IFrame messages.</p>
<ul>
<li>messages have a unique <code>id</code> used to correlate response to requests.</li>
<li>a <code>response</code> message can be requested. The <code>id</code> identifer can be used to correlate a receive response to the original query.</li>
<li>all message sent by the extension must contain the extension id, <code>extId</code>. This identifier is passed when loading the IFrame (see <strong>Initialization</strong>)</li>
</ul>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">// sending message
var msg = {
    id: Math.random().toString(),
    type: "pxtpkgext",
    action: "extinit",
    extId: extId,
    response: true
}
window.parent.postMessage(msg, "*");

// handle the response
function receivedResponse(resp) {
  if (resp.action === "extinit")
    console.log('initialized!')
}
window.addEventListener("message", function(ev) {
  var resp = ev.data;
  if (resp && resp.type === "pxtpkgext")
    receivedResponse(resp);
}, false);
</code></pre>
<h3 id="Initialization"><a href="#Initialization" class="headerlink" title="Initialization"></a>Initialization</h3><p>When the user presses the extension button,</p>
<ul>
<li>The GitHub pages site is loaded in an IFrame with an extension id in the hashmark, e.g. <a href="https://microsoft.github.io/pxt-neoanim/#extid" target="_blank" rel="external">https://microsoft.github.io/pxt-neoanim/#extid</a> for the package <a href="https://github.com/Microsoft/pxt-neoanim" target="_blank" rel="external">https://github.com/Microsoft/pxt-neoanim</a>.</li>
</ul>
<h3 id="hint"><a href="#hint" class="headerlink" title="~ hint"></a>~ hint</h3><p>Store the extension id as it needs to be used in every message.</p>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">var extId = window.location.hash.substr(1);
</code></pre>
<h3 id=""><a href="#" class="headerlink" title="~"></a>~</h3><ul>
<li>Once fully loaded, the extension sends a <code>extinit</code> message to the parent window</li>
</ul>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">var msg = {
    id: Math.random().toString(),
    type: "pxtpkgext",
    action: "extinit",
    extId: extId
}
...
</code></pre>
<h3 id="Read-and-write-code"><a href="#Read-and-write-code" class="headerlink" title="Read and write code"></a>Read and write code</h3><p>The extension can read (<code>extreadcode</code>) and write (<code>extwritecode</code>) a dedicated TypeScript and JSON file in the project. The JSON file is designed to store rich metadata while the TypeScript is the “code behind” that gets executed. This feature does not require permissions.</p>
<ul>
<li>write code</li>
</ul>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">var msg = {
    id: Math.random().toString(),
    type: "pxtpkgext",
    action: "extwritecode",
    extId: extId,
    body: {
        code: "// generated TypeScript code",
        json: "serialized JSON here"
    }
}
...
</code></pre>
<ul>
<li>read code</li>
</ul>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">var id = Math.random().toString();
var msg = {
    id: id,
    type: "pxtpkgext",
    action: "extreadcode",
    extId: extId,
    response: true
}
...

function receivedResponse(resp) {
  if (resp.action === "extreadcode" && resp.id === id && resp.body) {
      var ts = resp.body.code;
      var json = JSON.parse(resp.body.json);
      ...
  }
}
...
</code></pre>
<h3 id="Read-and-write-user-code"><a href="#Read-and-write-user-code" class="headerlink" title="Read and write user code"></a>Read and write user code</h3><p>The <code>extusercode</code> message requests to read the entire set of files in the project. The user will be prompted to give permission. If successfull, the response contains a <code>resp</code> field with a map of the file names to file contents.</p>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">export interface UserCodeResponse extends ExtensionResponse {
    /* A mapping of file names to their contents */
    resp?: { [index: string]: string };
}
</code></pre>
<h3 id="Data-streams"><a href="#Data-streams" class="headerlink" title="Data streams"></a>Data streams</h3><p>When available, the editor may stream data coming from the devices. The <code>extdatastream</code> message requests to stream data. The user will be prompted to give permission. The following message requests for serial messages:</p>
<pre class=" language-typescript-ignore"><code class="language-typescript-ignore">var msg {
    ...
    action: "extdatastream",
    body: {
        serial: true
    }
}
...
</code></pre>
<p>If successful, the editor will proxy serial messages to the editor IFrame.</p>

    </div>
    <h2 class="post-nav">
      
      <a href="/2017/10/11/pxt-package-pxtjson/" class="prev">上一篇：配置package | PXT</a>
      
      <a href="#" class="next">下一篇：无</a>

    </h2>

    <div class="footer">
      Copyright @ <a href="/">lian</a> | 2009-2017
    </div>
  </div>

  <script src="/js/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.js"></script>
  <script src="/js/post.js"></script>


</body>

</html>

